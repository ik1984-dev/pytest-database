# –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
from sqlalchemy import create_engine  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
from sqlalchemy.orm import sessionmaker  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π —Ä–∞–±–æ—Ç—ã —Å –ë–î
from sqlalchemy.orm import declarative_base  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –º–æ–¥–µ–ª–µ–π
import os  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
from dotenv import load_dotenv  # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env —Ñ–∞–π–ª–∞

# üìÅ –ó–ê–ì–†–£–ó–ö–ê –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø
# –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ .env –≤ —Ç–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
load_dotenv()

# üîó –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï URL –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•
# –§–æ—Ä–º–∞—Ç: postgresql://username:password@host:port/database_name
# –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
DATABASE_URL = f"postgresql://{os.getenv('DB_USER')}:{os.getenv('DB_PASSWORD')}@{os.getenv('DB_HOST')}:{os.getenv('DB_PORT')}/{os.getenv('DB_NAME')}"

# üöÄ –°–û–ó–î–ê–ù–ò–ï –î–í–ò–ñ–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•
# –î–≤–∏–∂–æ–∫ - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏
engine = create_engine(DATABASE_URL)

# üéØ –°–û–ó–î–ê–ù–ò–ï –§–ê–ë–†–ò–ö–ò –°–ï–°–°–ò–ô
# SessionLocal - —ç—Ç–æ —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π —Ä–∞–±–æ—Ç—ã —Å –ë–î
SessionLocal = sessionmaker(
    autocommit=False,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
    autoflush=False,   # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Å–µ—Å—Å–∏—é (–ª—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
    bind=engine        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É –¥–≤–∏–∂–∫—É
)

# üèóÔ∏è –°–û–ó–î–ê–ù–ò–ï –ë–ê–ó–û–í–û–ì–û –ö–õ–ê–°–°–ê –î–õ–Ø –ú–û–î–ï–õ–ï–ô
# –í—Å–µ –º–æ–¥–µ–ª–∏ SQLAlchemy –±—É–¥—É—Ç –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞
Base = declarative_base()

# üîÑ –ì–ï–ù–ï–†–ê–¢–û–† –°–ï–°–°–ò–ô –î–õ–Ø FASTAPI DEPENDENCIES
def get_db():
    """
    –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ FastAPI –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    """
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    db = SessionLocal()
    try:
        # –û—Ç–¥–∞–µ–º —Å–µ—Å—Å–∏—é –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞
        yield db
    finally:
        # –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã (–¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
        db.close()